---
title: "Method comparision"
author: "Alexander Schwaiger"
date: "2023-01-20"
output: pdf_document
---
```{r eval=FALSE, message=FALSE, warning=FALSE}
source("General_Dependency.R")
source("Coda_Function.R") 
source("Ingarch_Function.R")
source("General_Function.R")
```


Plot parameters 
```{r eval = FALSE}
text_size <- 50
save_plots <- F
```


Preparation
```{r eval = FALSE}

#Choosing only fridges with all 4 categories
help1 <- weekly_category_data%>%
  group_by(fridge_id)%>%
  dplyr::select(main_category_id)%>%
  unique()%>%
  count(fridge_id)
  
ids_all <- help1$fridge_id[help1$n ==4]

ids <- ids_all

if(all(ids == ids_all)){
  ids_save <- "_all_"
}else {
  ids_save <- paste(ids,collapse = "-")
}

PredictionStep <- 1
frame <- 0.3
window_method <- "extending"
save_results <- T

#Ingarch specifications
distr<-"poisson"
zero_handling_ingarch <- "zero_to_one"
external <- T
if(external){
  external_plot <-"with external factors"
}else external_plot <- ""
past_means <- c(1)
past_obs <- c(1)
ingarch_settings <- expand_grid(past_means,past_obs)


#Coda specifications
zero_handling_coda<-"all"
tspace<-T
take_log<-T
one_vs_all<-T
```


Performing the Analysis
```{r eval=FALSE, include=FALSE}
coda_result <-
  Coda.Analysis(
    Data_Raw  = weekly_category_data,
    Id = ids,
    Frame = frame,
    OneVsAll = one_vs_all,
    PivotGroup =  c("1", "2", "3", "4"),
    TSpace = T,
    Log = T,
    ZeroHandling = zero_handling_coda,
    WindowMethod = window_method
  )

if(save_results){
  save(coda_result,file=here("Code/results",paste("coda_result_ids",paste(ids_save,collapse="-"),"win_lgth",gsub("[.]","",frame),".RData",sep="")))
}


ingarch_result <-
  Ingarch.Analysis(
    Data_Raw= weekly_category_data,
    Id = ids,
    Frame = frame,
    Distribution = distr,
    Category = c("1","2","3","4"),
    WindowMethod = window_method,
    ZeroHandling = zero_handling_ingarch,
    External = external,
    Multicore = T,
    NCores = 10,
    PastOb = past_obs,
    PastMean = past_means
  )
  
  if(save_results){
  save(ingarch_result,file=here("Code/results",paste("ingarch_result_ids",paste(ids_save,collapse="-"),"_ext","_",external,
                                             "_win_lgth",gsub("[.]","",frame),"_pobs",past_obs,"_pmeansu",past_mean,".RData",sep="")))

}
```

Loading previous result
```{r eval=FALSE, include=FALSE}
ids <- unique(coda_result$result$id)
PredictionStep <- 1
frame <- unique(coda_result$result$frame)
window_method <- unique(coda_result$result$windowMethod)
save_results <- F

#Ingarch specifications
distr<-unique(ingarch_result$result$distribution)
zero_handling_ingarch <- unique(ingarch_result$result$zeroHandling)
external <- unique(ingarch_result$result$external)
if(external){
  external_plot <-"with external factors"
}else external_plot <- ""
past_means <- unique(ingarch_result$result$pastMean)
past_obs <- unique(ingarch_result$result$pastOb)
ingarch_settings <- expand_grid(past_means,past_obs)


#Coda specifications
#zero_handling_coda<-unique(coda_result$result$zero_handling)
tspace<-T
take_log<-T
one_vs_all<-T

if(!identical(ids,unique(ingarch_result$result$id)) || 
   frame != unique(ingarch_result$result$frame) ||
   window_method != unique(ingarch_result$result$windowMethod)) {
  stop("Ingarch and Coda base specifications differ")
}
```


Error measure calculations
```{r}

coda_model_error <- Model.Error(coda_result,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F)
ingarch_model_error <- Model.Error(ingarch_result,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F)
model_error <- rbind(coda_model_error,ingarch_model_error)



coda_model_error_split <- Model.Error(coda_result,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = T)
ingarch_model_error_split <- Model.Error(ingarch_result,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = T)
model_error_split <- rbind(coda_model_error_split,ingarch_model_error_split)

                                             
```

```{r}
psa<-ggplot(model_error,aes(x=id,y=error,col=model))+
  geom_point(size=5)+
  scale_y_continuous(limits=c(0,3))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1,size=10))+
  ggtitle(paste("Error measures",sep=" "),subtitle = paste("Window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Both_ErrorMeasure_combined",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=psa,height = 15,width = 20)
}
```

```{r}
my_color_groups <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))

my_color_methods <- setNames(c("red", "blue"),
                     c("ingarch","coda"))

ps<-ggplot(model_error_split,aes(x=id,y=error))+
  geom_point(size=7,shape=21,aes(colour=model,fill=group),stroke=4)+
  scale_y_continuous(limits=c(0,3))+
  geom_hline(yintercept =1,linewidth=2)+
  scale_fill_manual("Legend", values = c(my_color_groups),aesthetics = "fill")+
  scale_colour_manual("Legend", values = c(my_color_methods),aesthetics = "colour")+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1,size=10))+
  ggtitle(paste("Error measures ",sep=" "),subtitle = paste("Window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Both_ErrorMeasure_PointPlot",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=ps,height = 15,width = 20)
}
```

```{r}
my_color <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))
phc <- ggplot(coda_model_error_split,aes(x=error,colour=group,fill=group))+
  geom_histogram(bins=100,position = "identity",alpha=0.3,linewidth=1)+
  scale_x_continuous(limits=c(0,5))+
  scale_y_continuous(limits=c(0,12))+
  geom_vline(xintercept = 1,linewidth=2)+
  scale_color_manual("Legend", values = c(my_color))+
  scale_fill_manual("Legend", values = c(my_color))+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1))+
  ggtitle(paste("Coda Error measures per group",sep=" "),subtitle = paste("Window length:",frame,sep=" "))
phc

if(save_plots){
  ggsave(filename = here("Plots",paste("Coda_ErrorMeasure_PerGroup_Histogram",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=phc,height = 15,width = 20)
}
```



```{r}
my_color <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))
phi <- ggplot(ingarch_model_error_split,aes(x=error,colour=group,fill=group))+
  geom_histogram(bins=100,position = "identity",alpha=0.3)+
  scale_x_continuous(limits=c(0,5))+
  scale_y_continuous(limits=c(0,12))+
  geom_vline(xintercept = 1,linewidth=2)+
  scale_color_manual("Legend", values = c(my_color))+
  scale_fill_manual("Legend", values = c(my_color))+
  theme(text = element_text(size = text_size))+
  ggtitle(paste("Ingarch Error measures per group",sep=" "),subtitle = paste("Window length:",frame,sep=" "))
phi
if(save_plots){
  ggsave(filename = here("Plots",paste("Ingarch_ErrorMeasure_PerGroup_Histogram",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=phi,height = 15,width = 20)
}
```


```{r}
my_color <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))

psc<-ggplot(coda_model_error_split,aes(x=id,y=error,col=group))+
  geom_point(size=3)+
  scale_y_continuous(limits=c(0,3))+
  theme(text = element_text(size = text_size))+
  scale_color_manual("Legend", values = c(my_color))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1))+
  ggtitle(paste("Coda Fridge error measures per group",sep=" "),subtitle = paste("Window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Coda_ErrorMeasure_PerGroup_PointPlot",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=psc,height = 15,width = 20)
}
```

```{r}
my_color <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))

psi<-ggplot(ingarch_model_error_split,aes(x=id,y=error,col=group))+
  geom_point(size=3)+
  scale_y_continuous(limits=c(0,3))+
  theme(text = element_text(size = text_size))+
  scale_color_manual("Legend", values = c(my_color))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1))+
  ggtitle(paste("Ingarch Error measures per group",sep=" "),subtitle = paste("Window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Ingarch_ErrorMeasure_PerGroup_PointPlot",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=psi,height = 15,width = 20)
}
```

Preparing Data for plotting

```{r}
FID <- 8

plot_data_coda<-coda_result$result%>%
  dplyr::filter(category %in% c(1,2,3,4), id==FID)%>%
  dplyr::select(!c(valuePredict_naive,predictionError_naive))

all_dates_and_categories<-plot_data_coda[,c("category","date")]

plot_data_ingarch <- ingarch_result$result %>% dplyr::filter(id==FID)
plot_data_ingarch<-full_join(plot_data_ingarch,all_dates_and_categories)
plot_data_ingarch$model<-"ingarch"

if(one_vs_all) {
  plot_data <-
    bind_rows(plot_data_coda, plot_data_ingarch) %>% dplyr::select(!c(distribution, pivotGroup))
} else{
  plot_data <-
    bind_rows(plot_data_coda, plot_data_ingarch) %>% dplyr::select(!c(distribution))
}



```

```{r eval=FALSE, include=FALSE}
FID = 4

ingarch_ext <- Object.Load("F:/Uni/Masterarbeit/Simulation/Master-Thesis/Code/results/ingarch_result_ids_all__ext_FALSE_win_lgth05_pobs2_pmeansu1.RData")
ingarch_norm <- Object.Load("F:/Uni/Masterarbeit/Simulation/Master-Thesis/Code/results/ingarch_result_ids_all__ext_TRUE_win_lgth05_pobs1_pmeansu1.RData")
frame <- 0.5

plot_data_ingarch_ext <- ingarch_ext$result %>% dplyr::filter(id==FID)
plot_data_ingarch_norm <- ingarch_norm$result %>% dplyr::filter(id==FID)

plot_data_ingarch_norm$model<-"NoExternal"
plot_data_ingarch_ext$model<-"External"

plot_data<-bind_rows(plot_data_ingarch_ext,plot_data_ingarch_norm)

```

```{r eval=FALSE, include=FALSE}

ingarch_ext_error <- Model.Error(ingarch_ext,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F)
ingarch_ext_error$model <- "External"
ingarch_norm_error <- Model.Error(ingarch_norm ,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F)
ingarch_norm_error$model <- "NoExternal"
model_error <- rbind(ingarch_ext_error,ingarch_norm_error)



ingarch_ext_error_split <- Model.Error(ingarch_ext,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = T)
ingarch_ext_error_split$model <- "External"
ingarch_norm_error_split <- Model.Error(ingarch_norm,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = T)
ingarch_norm_error_split$model <- "NoExternal"
model_error_split <- rbind(ingarch_ext_error_split,ingarch_norm_error_split)

                                             
```

```{r eval=FALSE, include=FALSE}
psa<-ggplot(model_error,aes(x=id,y=error,col=model))+
  geom_point(size=5)+
  scale_y_continuous(limits=c(0,3))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1,size=10))+
  ggtitle(paste("Error measures",sep=" "),subtitle = paste("Window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Ingarch_Both_ErrorMeasure_combined",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=psa,height = 15,width = 20)
}
```

```{r eval=FALSE, include=FALSE}
my_color_groups <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))

my_color_methods <- setNames(c("red", "blue"),
                     c("External","NoExternal"))

ps<-ggplot(model_error_split,aes(x=id,y=error))+
  geom_point(size=7,shape=21,aes(colour=model,fill=group),stroke=4)+
  scale_y_continuous(limits=c(0,3))+
  geom_hline(yintercept =1,linewidth=2)+
  scale_fill_manual("Legend", values = c(my_color_groups),aesthetics = "fill")+
  scale_colour_manual("Legend", values = c(my_color_methods),aesthetics = "colour")+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1,size=10))+
  ggtitle(paste("Error measures ",sep=" "),subtitle = paste("Window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Ingarch_Both_ErrorMeasure_PointPlot",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=ps,height = 15,width = 20)
}
```

Cumulated RMSEs 
```{r}
PlotErrorMeasure_Cum <- ErrorMeasure.Cumulated(plot_data,Fnct="Rmse")
PlotErrorMeasure_Cum$window <- factor(as.character(PlotErrorMeasure_Cum$window),levels=unique(PlotErrorMeasure_Cum$window))


p8 <- ggplot(PlotErrorMeasure_Cum, aes(y=errorMeasure,x=window,group=model,col=model))+
  facet_wrap(vars(category),nrow=length(unique(PlotErrorMeasure_Cum$category)),scales = "free")+
  geom_line()+
  geom_point(size=1.5)+
  theme(text = element_text(size = 30),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1))+
    ggtitle(paste("Cumulated RMSE from right to left",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))

p8

if(save_plots){
ggsave(filename = here("Plots",paste("Ingarch_rmse_cum",FID,"win_lgth",frame,".png",sep="")),plot=p8,height = 15,width = 20)
  
}
```
Show whole timeseries
```{r}
data_raw <- weekly_category_data %>%
          filter(fridge_id == FID&
                   main_category_id %in% c(1, 2, 3, 4)) %>%
          dplyr::select(week_date, main_category_id, sold) %>%
          Data.Preparation() %>% 
          pivot_longer(cols=c("1","2","3","4"),names_to="category",values_to="valueTrue")
names(data_raw)[1] <- c("date")
        
```


Ingarch Timeseries with prediction intervals

```{r}
p<-ggplot(plot_data_ingarch,aes(x=date,y=valuePredict),col="blue")+
  facet_wrap(vars(category),nrow=length(unique(plot_data_ingarch$category)),scales = "free")+
  geom_point(size=1)+
  geom_ribbon(aes(x=date,y=valuePredict,ymin=lowerBound,ymax=upperBound),
              data=plot_data_ingarch,inherit.aes = F,fill="grey90",linetype="dashed",col="blue")+
  geom_line(data=plot_data_ingarch,
            aes(x=date,y=valuePredict),col="blue")+
  geom_line(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  geom_point(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  theme(text = element_text(size = text_size))+
  ggtitle(paste("Ingarch Timeseries",external_plot,sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("ts_ing_id_",FID,"_",distr,"_pi","_ext","_",external,"win_lgth",frame,".png",sep="")),plot=p,height = 15,width = 20)
}

```




Coda Timeseries with prediction intervals
```{r}
p0<-ggplot(plot_data_coda,aes(x=date,y=valuePredict),col="red")+
  facet_wrap(vars(category),nrow=length(unique(plot_data_coda$category)),scales = "free")+
  geom_point(size=1)+
  geom_ribbon(aes(x=date,y=valuePredict,ymin=lowerBound,ymax=upperBound),
              data=plot_data_coda,inherit.aes = F,fill="grey90",linetype="dashed",col="red")+
  geom_line(data=plot_data_coda,
            aes(x=date,y=valuePredict),col="red")+
  geom_line(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  geom_point(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  theme(text = element_text(size = text_size))+
  ggtitle(paste("Coda Timeseries",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))

if(save_plots){
 ggsave(filename = here("Plots",paste("ts_coda_id_",FID,"_pi","win_lgth",frame,".png",sep="")),plot=p0,height = 15,width = 20) 
}

```

Comparing the timeseries with prediction intervals

```{r}
#my_color <- setNames(c("red", "blue"),
#                     c("coda","ingarch"))

p1<-ggplot(plot_data,aes(x=date,y=valuePredict,col=model))+
  facet_wrap(vars(category),nrow=length(unique(plot_data$category)),scales = "free")+
  geom_point(size=1)+
  geom_ribbon(aes(x=date,y=valuePredict,col=model,ymin=lowerBound,ymax=upperBound,fill=model),
              data=plot_data,alpha=0.15,inherit.aes = F,linetype="dashed")+
  geom_line(data=plot_data,
            aes(x=date,y=valuePredict,col=model))+
  geom_line(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  geom_point(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  #scale_color_manual("Legend", values = c(my_color))+
  ggtitle(paste("Actual Timeseries vs. predicted ",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))+
  theme(text = element_text(size = text_size))  

if(save_plots){
ggsave(filename = here("Plots",paste("Ingarch_ts_both_id_",FID,"_pi","ing_ext",external,"win_lgth",frame,".png",sep="")),plot=p1,height = 15,width = 20)
  
}
```



Comparing the prediction errors of the models

```{r}
p2<-ggplot(plot_data,aes(x=model,y=predictionError))+
  facet_wrap(vars(category),ncol=length(unique(plot_data$category)),scales = "fixed")+
  geom_boxplot()+
  ggtitle("Prediction error",subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))+
  theme(text = element_text(size = text_size))+
  geom_hline(yintercept = 0,col="blue4")

if(save_plots){
 ggsave(filename = here("Plots",paste("box_pred_err_id",FID,"win_lgth",frame,".png",sep="")),plot=p2,height = 15,width = 20)
 
}
```


Ingarch Parameter / Model Check

```{r eval=FALSE, include=FALSE}
for(category in c(1:4)){
  
  ingarch.parameter.plot(ingarch_result,category=category,element="fitted.values",save=F,plot.type = "default")
  ingarch.parameter.plot(ingarch_result,category=category,element="fitted.values",save=F,plot.type = "histogram")
  
  ingarch.parameter.plot(ingarch_result,category=category,element="fitted.values",save=F,plot.type = "default",func="mean")
  ingarch.parameter.plot(ingarch_result,category=category,element="fitted.values",save=F,plot.type = "histogram",func="mean")
}

```


Normed Prediction errors 
```{r}
p3 <- ggplot(plot_data,aes(x=date,y=predictionError_normed,col=model))+
  facet_wrap(vars(category),nrow=length(unique(plot_data$category)),scales = "free")+
  geom_point(size=1.5,aes(shape=model))+
  geom_line()+
  theme(text = element_text(size = text_size))+
  geom_line(aes(y=0),col="black")+
  ggtitle(paste("Normed prediction error over time ",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))#+
 # scale_color_manual("Legend", values = c(my_color))

if(save_plots){
 ggsave(filename = here("Plots",paste("Ingarch_pred_err_norm_id",FID,"win_lgth",frame,".png",sep="")),plot=p3,height = 15,width = 20)
 
}
```



```{r}
p4<-ggplot(plot_data,aes(x=model,y=predictionError_normed))+
  facet_wrap(vars(category),ncol=length(unique(plot_data$category)),scales = "fixed")+
  geom_boxplot()+
  ggtitle("Normed prediction error per method and category",subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))+
  theme(text = element_text(size = text_size))+
  geom_hline(yintercept = 0,col="blue4")

if(save_plots){
 ggsave(filename = here("Plots",paste("Ingarch_box_pred_err_norm_id",FID,"win_lgth",frame,".png",sep="")),plot=p4,height = 15,width = 20)
 
}
```


Lag order of coda model

```{r}

plot_coda_lag <- Coda.GetLag(coda_result,Id=FID)
p5 <- ggplot(plot_coda_lag, aes(x = window, y = lag)) +
  geom_point(size = 1.5) +
  geom_line() +
  ggtitle(paste("Coda model lag per window", sep = " "),
          subtitle = paste("Fridge ID:", FID,",base window length:",frame, sep = " ")) +
  theme(text = element_text(size = text_size))

if (one_vs_all)
  p5<- p5 + facet_wrap(vars(category), nrow = length(unique((
    plot_coda_lag$category
  ))), scales = "free")

if(save_plots){
ggsave(filename = here("Plots",paste("Coda_lag_id",FID,"win_lgth",frame,".png",sep="")),plot=p5,height = 15,width = 20)
  
}
```


```{r eval=FALSE, include=FALSE}
par(mfrow=c(3,2))
worst_windows <- coda_result$result%>%filter(category%in%c("1","2","3","4"))%>%slice_max(n=3,order_by=abs(predictionError_normed))%>%dplyr::select(window,category)
best_windows <- coda_result$result%>%filter(category%in%c("1","2","3","4"))%>%slice_min(n=3,order_by=abs(predictionError_normed))%>%dplyr::select(window,category)

windows <-c(best_windows$window[1:3],worst_windows$window[1:3])
categories <- c(best_windows$category[1:3],worst_windows$category[1:3])
value <- rep(c("best","worst"),each=3)

for(i in 1:6){
plot_coda_det <- Coda.GetCoefficients(coda_result) %>% filter(window==windows[i],category==categories[i])
plot(plot_coda_det$model_det,main=paste("window",i,value[i]),ylim=c(0,2))
abline(h=1)  
}

```


Prediction error over time
```{r}
p6 <- ggplot(plot_data,aes(x=date,y=predictionError,col=model))+
  facet_wrap(vars(category),nrow=length(unique(plot_data$category)),scales = "free")+
  geom_point(size=1.5,aes(shape=model))+
  geom_line()+
  theme(text = element_text(size = text_size))+
  geom_line(aes(y=0),col="black")+
  ggtitle(paste("Prediction error over time ",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))+
  scale_color_manual("Legend", values = c(my_color))

if(save_plots){
ggsave(filename = here("Plots",paste("pred_err_id",FID,"win_lgth",frame,".png",sep="")),plot=p6,height = 15,width = 20)
  
}
```

Coda coefficients over windows 
```{r}
plot_coda_det <- Coda.GetCoefficients(coda_result,fnc="det",Id=FID)

p7 <- ggplot(plot_coda_det,aes(x=window,y=value))+
  geom_point(size=1.5)+
  theme(text = element_text(size = text_size))+
  ggtitle(paste("Determinant of the coefficient matrices",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))

if (one_vs_all)
  p7<- p7 + facet_wrap(vars(category), nrow = length(unique((
    plot_coda_det$category
  ))), scales = "free")

if(save_plots){
ggsave(filename = here("Plots",paste("coda_det_id",FID,"win_lgth",frame,".png",sep="")),plot=p7,height = 15,width = 20)
  
}
```




