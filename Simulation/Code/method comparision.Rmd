---
title: "Method comparision"
author: "Alexander Schwaiger"
date: "2023-01-20"
output: pdf_document
---
```{r eval=FALSE, message=FALSE, warning=FALSE}
source("General_Dependency.R")
source("Coda_Function.R") 
source("Ingarch_Function.R")
source("ZIM_Function.R")
source("General_Function.R")
source("General_PlotFunctions.R")
```


Plot parameters 
```{r eval = FALSE}
text_size <- 50
save_plots <- F
```


Preparation
```{r eval = FALSE}

#Choosing only fridges with all 4 categories
help1 <- weekly_category_data%>%
  group_by(fridge_id)%>%
  dplyr::select(main_category_id)%>%
  unique()%>%
  count(fridge_id)
  
ids_all <- help1$fridge_id[help1$n ==4]

ids <- ids_all

if(all(ids == ids_all)){
  ids_save <- "_all_"
}else {
  ids_save <- paste(ids,collapse = "-")
}

frame <- 0.5
window_method <- "extending"
save_results <- F
HistoryLength <- 1

#Ingarch specifications
MainCat <- 2

#Coda specifications

```


Performing the Analysis
```{r eval=FALSE, include=FALSE}
coda_result <-
  Coda.Analysis(
    Data_Raw  = weekly_category_data,
    Id = ids_all,
    Frame = frame,
    OneVsAll = T,
    PivotGroup =  c("1", "2", "3", "4"),
    TSpace = T,
    Log = T,
    ZeroHandling = "all",
    WindowMethod = window_method,
    HistoryLength = HistoryLength
  )

if(save_results){
  save(coda_result,file=here("Code/results",paste("coda_result_ids",paste(ids_save,collapse="-"),".RData",sep="")))
}


ingarch_result <-
  Ingarch.Analysis(
    Data_Raw= weekly_category_data,
    Id = 100402,
    Frame = frame,
    Distribution = "poisson",
    Category_Main = c("4"),
    WindowMethod = window_method,
    ZeroHandling = "none",
    External = F,
    Multicore = F,
    NCores = 10,
    PastOb = 1,
    PastMean = 1,
    HistoryLength = HistoryLength,
    TakeSubCategory = F
  )
  
  if(save_results){
  save(ingarch_result,file=here("Code/results",paste("ingarch_result_ids",paste(ids_save,collapse="-"),".RData",sep="")))

  }

zim_result <- Zim.Analysis(
    Data_Raw = weekly_category_data,
    Id = ids_all,
    Frame = frame,
    Distribution = "poisson",
    Category_Main = c("1","2","3","4"),
    WindowMethod = window_method,
    Multicore = F,
    HistoryLength = 1,
    TakeSubCategory = F
  )

  if(save_results){
  save(zim_result,file=here("Code/results",paste("zim_result_ids",paste(ids_save,collapse="-"),".RData",sep="")))

  }
```

Loading previous result
```{r}
ids <- unique(coda_result$result$id)
PredictionStep <- 1
frame <- unique(coda_result$result$frame)
window_method <- unique(coda_result$result$windowMethod)
save_results <- F
HistoryLength <- unique(coda_result$result$history)

#Ingarch specifications
distr<-unique(ingarch_result$result$distribution)
zero_handling_ingarch <- unique(ingarch_result$result$zeroHandling)
external <- unique(ingarch_result$result$external)
if(external){
  external_plot <-"with external factors"
}else external_plot <- ""
past_means <- unique(ingarch_result$result$pastMean)
past_obs <- unique(ingarch_result$result$pastOb)
ingarch_settings <- expand_grid(past_means,past_obs)
MainCat <- unique(ingarch_result$result$main_category)


#Coda specifications
#zero_handling_coda<-unique(coda_result$result$zero_handling)
tspace<-T
take_log<-T
one_vs_all<-T

if(!identical(ids,unique(ingarch_result$result$id)) || 
   frame != unique(ingarch_result$result$frame) ||
   window_method != unique(ingarch_result$result$windowMethod) ||
   HistoryLength != unique(ingarch_result$result$history)) {
  stop("Ingarch and Coda base specifications differ")
}
```


```{r}
Coda03 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/coda_result_ids_all__frame_method_overlapping.RData")
Coda05 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/coda_result_ids_all_win_lgth05_history_lght1.RData")
#Coda07 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/coda_result_ids_all_win_lgth07_history_lght1.RData")


Ingarch03 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/ingarch_result_ids_all__frame_method_overlapping.RData")
Ingarch05 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/ingarch_result_ids_all__win_lgth05_history_lght1.RData")
#Ingarch07 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/ingarch_result_ids_all__win_lgth07_history_lght1.RData")

Coda_Combined <- rbind(Coda03$result,Coda05$result)
Ingarch_Combined <- rbind(Ingarch03$result,Ingarch05$result)

Plot.ErrorMeasureCombined(CodaCombined = Coda_Combined,IngarchCombined = Ingarch_Combined,Values=c("extending","fixed"),Split=F,Variation = "windowMethod")

History <- unique(Coda_Combined $history)


i <- 1
for(History_RunVariable in History){
  CodaData <- Coda_Combined %>% filter(history == History_RunVariable)
  CodaModelError_Single <- Model.Error(CodaData,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F)
  CodaModelError_Single$history <- History_RunVariable
  
  IngarchData <- Ingarch_Combined %>% filter(history == History_RunVariable)
  IngarchModelError_Single <- Model.Error(IngarchData,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F)
  IngarchModelError_Single$history <- History_RunVariable
  
  if(i==1){
    CodaModelError_All <- CodaModelError_Single
    IngarchModelError_All <- IngarchModelError_Single
  }
  else{
    CodaModelError_All <- rbind(CodaModelError_All,CodaModelError_Single)
    IngarchModelError_All <- rbind(IngarchModelError_All,IngarchModelError_Single)
  }
  i <- i+1
}

    ModelErrorAll <- rbind(CodaModelError_All,IngarchModelError_All)
    Variation <- "history"
    Values <- c("0.5","1")
    
    
    
    ModelErrorAll$model <- as.factor(ModelErrorAll$model)
    levels(ModelErrorAll$model) <- list(CoDA = "coda", INGARCH = "ingarch")
    #Boxplot
    BoxPlot <- ggplot(ModelErrorAll ,aes(x=model,y=error))+
      facet_wrap(vars(!!as.symbol(Variation)),ncol=length(Values),scales = "fixed")+
      geom_boxplot()+
      scale_y_continuous(limits=c(0,5))+
      geom_hline(yintercept =1,linewidth=2)+
      theme(text = element_text(size = 50),axis.text.x = element_text(size=30))+
      ggtitle(paste("Error Measure Boxplot",sep=" "))+
      xlab("Models")+
      ylab("Errors")
    
      ggsave(filename = here("Plots",paste("ErrorMeasureCombined_Box",ids_save,"_Variation_",VariationParameter,".png",sep="")),plot=BoxPlot ,height = 15,width = 20)
      
  

      MyColour <- setNames(c("red", "blue"),
                           c("CoDA","INGARCH"))
      
      i <- 1
      for(Variation_RunVariable in Values){
        
      Ingarch_Combined_Single <- Ingarch_Combined %>% filter(!!as.symbol(Variation)==Variation_RunVariable)
      length <- Ingarch_Combined_Single%>% group_by(id) %>% dplyr::summarise(n=unique(window_baseLength))
      
      TimeSeries_Length <- Ingarch_Combined_Single%>% group_by(id) %>% dplyr::summarise(n=unique(timeseriesLength))
      
      names(TimeSeries_Length) <- c("id","Length")
      TimeSeries_Length$Length <- as.numeric(TimeSeries_Length$Length)
      
      
      IngarchError_Sorted <- ModelErrorAll %>% filter(model=="INGARCH" & !!as.symbol(Variation)==Variation_RunVariable)%>%arrange(.,error)
      IngarchQuantiles <- quantile(IngarchError_Sorted$error,na.rm = T)
      IngarchError_Sorted$index <- seq(1:dim(IngarchError_Sorted)[1])
      IngarchError_Sorted <- full_join(IngarchError_Sorted,TimeSeries_Length,bye ="id")
      
      Quantiles_Index <- data.frame(quant_ind=findInterval(IngarchQuantiles,IngarchError_Sorted$error))
      
      CodaError_Sorted <- ModelErrorAll  %>% filter(model=="CoDA" & !!as.symbol(Variation)==Variation_RunVariable)%>%arrange(.,error)
      CodaQuantiles <- quantile(CodaError_Sorted$error,na.rm = T)
      CodaError_Sorted$index <- seq(1:dim(CodaError_Sorted)[1])
      CodaError_Sorted <- full_join(CodaError_Sorted,TimeSeries_Length,bye ="id")
        
      if(i==1){
        CodaError_Sorted_All <- CodaError_Sorted
        IngarchError_Sorted_All <- IngarchError_Sorted
      }else{
        CodaError_Sorted_All  <- rbind(CodaError_Sorted_All ,CodaError_Sorted)
        IngarchError_Sorted_All <- rbind(IngarchError_Sorted_All,IngarchError_Sorted)
        }
      i <- i+1
      }
      
      
      QuantPlot <- ggplot(IngarchError_Sorted_All,aes(x=index,y=error,colour=model,size=Length))+
        facet_wrap(vars(!!as.symbol(Variation)),nrow=length(Values),scales = "free")+
        geom_point()+
        scale_y_continuous(limits=c(0,5))+
        geom_point(data = CodaError_Sorted_All,aes(x=index,y=error,colour=model,size=Length))+
        geom_hline(yintercept=1,linewidth=2)+
        geom_vline(aes(xintercept=quant_ind),data=Quantiles_Index)+
        theme(text = element_text(size = 50))+
        scale_color_manual("Model", values = c(MyColour))+
        ggtitle(paste("Error Measure Quantile Plot",sep=" "))
      
      
      #Histogram
      
      ModelErrorAll_Median <- ModelErrorAll %>% dplyr::group_by(!!as.symbol(Variation),model) %>% summarise(Median=median(error,na.rm=T))
      ModelErrorAll_Mean <- ModelErrorAll %>% dplyr::group_by(!!as.symbol(Variation),model) %>% summarise(Mean=mean(error,na.rm=T))

      ModelErrorAll_MM <- full_join(ModelErrorAll_Mean,ModelErrorAll_Median,by=c("model",Variation)) %>% pivot_longer(cols=c("Mean","Median"),names_to="Type",values_to = "value")
        
      HistPlot <- ggplot(ModelErrorAll,aes(x=error,colour=model,fill=model))+
        facet_wrap(vars(!!as.symbol(Variation)),nrow=length(Values),scales = "free")+
  geom_histogram(bins=100,position = "identity",alpha=0.3,linewidth=1)+
  scale_x_continuous(limits=c(0,8))+
  scale_y_continuous(limits=c(0,12))+
  geom_vline(xintercept = 1,linewidth=2)+
  geom_vline(aes(xintercept=value,colour=model,linetype=Type),data = ModelErrorAll_MM ,linewidth=2)+
  scale_color_manual("Legend", values = c(MyColour ))+
  scale_fill_manual("Legend", values = c(MyColour ))+
  theme(text = element_text(size = 50))+
  ggtitle(paste("Error Measure Histogram",sep=" "),subtitle = paste("Window length:",frame,"History:",HistoryLength,sep=" ")) 
```

```{r}
x <- quantile(CodaError_Sorted_All$error,probs = 0.75,na.rm=T)
x <- 100
plot(c(1:length(sort(CodaError_Sorted_All$error[CodaError_Sorted_All$error < x & CodaError_Sorted_All$history=="0.5"]))),sort(CodaError_Sorted_All$error[CodaError_Sorted_All$error < x& CodaError_Sorted_All$history=="0.5"]))
```



Error measure calculations
```{r}

coda_model_error <- Model.Error(coda_result$result,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F)
ingarch_model_error <- Model.Error(ingarch_result$result,Fnct = "Mse",Category = unique(ingarch_result$result$category)) %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F,Category = as.numeric(unique(ingarch_result$result$category)))
model_error <- rbind(coda_model_error,ingarch_model_error)
zim_model_error <- Model.Error(zim_result$result,Fnct = "Mse",Category = unique(zim_result$result$category)) %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F,Category = as.numeric(unique(zim_result$result$category)))

model_error <- rbind(coda_model_error,ingarch_model_error,zim_model_error)


coda_model_error_split <- Model.Error(coda_result$result,Fnct = "Mse") %>% 
  Model.ErrorOverall(Fnct = "sum",SplitByGroup = T,Groups = list(1,2,3,4))

ingarch_model_error_split <- Model.Error(ingarch_result$result,Fnct = "Mse",Category =as.numeric(unique(ingarch_result$result$category))) %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = T,Groups = list(1,2,3,4))

zim_model_error_split <- Model.Error(zim_result$result,Fnct = "Mse",Category = unique(zim_result$result$category)) %>% 
  Model.ErrorOverall(Fnct = "sum",SplitByGroup = T,Groups = list(4))

model_error_split <- rbind(coda_model_error_split,ingarch_model_error_split,zim_model_error_split)


                                             
```

```{r}
psb<-ggplot(model_error,aes(x=model,y=error))+
  geom_boxplot()+
  #scale_y_continuous(limits=c(0,3))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1,size=10))+
  ggtitle(paste("Error measures",sep=" "),subtitle = paste("Window length:",frame, "History:",HistoryLength,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Both_ErrorMeasure_combined",ids_save,"_histlgth",HistoryLength,"win_lgth",frame,".png",sep="")),plot=psb,height = 15,width = 20)
}
```

```{r}
psb_zoomed<-ggplot(model_error,aes(x=model,y=error))+
  geom_boxplot()+
  scale_y_continuous(limits=c(0,3))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(size=30))+
  ggtitle(paste("Error measures",sep=" "),subtitle = paste("Window length:",frame, "History:",HistoryLength,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Both_ErrorMeasure_combined_zoomed",ids_save,"_histlgth",HistoryLength,"win_lgth",frame,".png",sep="")),plot=psb_zoomed,height = 15,width = 20)
}
```

```{r}
psbs<-ggplot(model_error_split,aes(x=model,y=error))+
  facet_wrap(vars(group),ncol=length(unique(ingarch_model_error_split$group)),scales = "fixed")+
  geom_boxplot()+
  scale_y_continuous(limits=c(0,5))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(size=30))+
  ggtitle(paste("Error measures",sep=" "),subtitle = paste("Window length:",frame, "History:",HistoryLength,"Main Cat.:",MainCat,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Both_ErrorMeasure_combined",ids_save,"_histlgth",HistoryLength,"_win_lgth",frame,"_maincat",MainCat,".png",sep="")),plot=psbs,height = 15,width = 20)
}
```


```{r}

psbs_zoomed<-ggplot(model_error_split,aes(x=model,y=error))+
  facet_wrap(vars(group),ncol=length(unique(model_error_split$group)),scales = "fixed")+
  geom_boxplot()+
  scale_y_continuous(limits=c(0,5))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(size=30))+
  ggtitle(paste("Error measures",sep=" "),subtitle = paste("Window length:",frame, "History:",HistoryLength,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Both_ErrorMeasure_split_zoomed",ids_save,"_all_models",".png",sep="")),plot=psbs_zoomed,height = 15,width = 20)
}

```


```{r}
length <- ingarch_result$result %>% group_by(id) %>% dplyr::summarise(n=unique(window_baseLength))

TimeSeries_Length <- data.frame(id = unique(ingarch_result$result$id),
                                length = length$n/
                                  (as.numeric(unique(ingarch_result$result$frame))*as.numeric(unique(ingarch_result$result$history))))
```


```{r}
my_color_methods <- setNames(c("red", "blue"),
                     c("coda","ingarch"))

IngarchError_Sorted <- model_error %>% filter(model=="ingarch")%>%arrange(.,error)
IngarchQuantiles <- quantile(IngarchError_Sorted$error,na.rm = T)
IngarchError_Sorted$index <- seq(1:dim(IngarchError_Sorted)[1])
IngarchError_Sorted <- full_join(IngarchError_Sorted,TimeSeries_Length,bye ="id")

Quantiles_Index <- data.frame(quant_ind=findInterval(IngarchQuantiles,IngarchError_Sorted$error))

CodaError_Sorted <- model_error %>% filter(model=="coda")%>%arrange(.,error)
CodaQuantiles <- quantile(CodaError_Sorted$error,na.rm = T)
CodaError_Sorted$index <- seq(1:dim(CodaError_Sorted)[1])
CodaError_Sorted <- full_join(CodaError_Sorted,TimeSeries_Length,bye ="id")

plot_quant <- ggplot(IngarchError_Sorted,aes(x=index,y=error,colour=model,size=length))+
  geom_point()+
  scale_y_continuous(limits=c(0,5))+
  geom_point(data = CodaError_Sorted,aes(x=index,y=error,colour=model,size=length))+
  geom_hline(yintercept=1,linewidth=2)+
  geom_vline(aes(xintercept=quant_ind),data=Quantiles_Index)+
  theme(text = element_text(size = text_size))+
  scale_colour_manual("Legend", values = c(my_color_methods),aesthetics = "colour")+
  ggtitle(paste("Error measures sorted",sep=" "),subtitle = paste("Window length:",frame, "History:",HistoryLength,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Quantile_Plot",ids_save,"_histlgth",HistoryLength,"win_lgth",frame,".png",sep="")),plot=plot_quant,height = 15,width = 20)
}
```

```{r}
my_color_methods <- setNames(c("red", "blue","green"),
                     c("coda","ingarch","zim"))

IngarchError_Sorted_split <- model_error_split %>% filter(model=="ingarch" & group =="4")%>%arrange(.,error)
IngarchQuantiles_split  <- quantile(IngarchError_Sorted_split $error,na.rm = T)

IngarchError_Sorted_split$index <- NA
IngarchError_Sorted_split[IngarchError_Sorted_split$group=="4",]$index <- seq(1:round(dim(IngarchError_Sorted_split )[1]))
IngarchError_Sorted_split <- inner_join(IngarchError_Sorted_split,TimeSeries_Length,bye ="id")

Quantiles_Index_split  <- data.frame(quant_ind=findInterval(IngarchQuantiles_split ,IngarchError_Sorted_split$error))

CodaError_Sorted_split  <- model_error_split  %>% filter(model=="coda"& group =="4")%>%arrange(.,error)
CodaQuantiles_split  <- quantile(CodaError_Sorted_split $error,na.rm = T)

CodaError_Sorted_split$index <- NA
CodaError_Sorted_split[CodaError_Sorted_split$group=="4",]$index <- seq(1:round(dim(CodaError_Sorted_split )[1]))
CodaError_Sorted_split <- inner_join(CodaError_Sorted_split,TimeSeries_Length,bye ="id")

zimError_Sorted_split  <- model_error_split  %>% filter(model=="zim"& group =="4")%>%arrange(.,error)
zimQuantiles_split  <- quantile(zimError_Sorted_split $error,na.rm = T)

zimError_Sorted_split$index <- NA
zimError_Sorted_split[zimError_Sorted_split$group=="4",]$index <- seq(1:round(dim(zimError_Sorted_split )[1]))
zimError_Sorted_split <- inner_join(zimError_Sorted_split,TimeSeries_Length,bye ="id")

Error_Sorted_split <- na.omit(rbind(CodaError_Sorted_split,IngarchError_Sorted_split,zimError_Sorted_split))
Error_Sorted_split$group <- as.factor(Error_Sorted_split$group)

plot_quant_split <- ggplot(Error_Sorted_split ,aes(x=index,y=error,colour=model,size=length))+
  facet_wrap(vars(group),nrow=length(unique(IngarchError_Sorted_split$group)),scales = "free")+
  geom_point()+
  scale_y_continuous(limits=c(0,5))+
  geom_hline(yintercept=1,linewidth=2)+
# geom_point(data = CodaError_Sorted_split,aes(x=index,y=error,colour=model),size=3)+
  geom_vline(aes(xintercept=quant_ind),data=Quantiles_Index_split)+
  theme(text = element_text(size = text_size))+
  scale_colour_manual("Legend", values = c(my_color_methods),aesthetics = "colour")+
  ggtitle(paste("Error measures sorted",sep=" "),subtitle = paste("Window length:",frame,"History:",HistoryLength,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Quantile_Plot_Split",ids_save,"_all_models",".png",sep="")),plot=plot_quant_split,height = 15,width = 20)
}
```



Ingarch Subcategories

```{r}
length <- ingarch_result$result %>% group_by(id) %>% dplyr::summarise(n=unique(window_baseLength))

TimeSeries_Length <- data.frame(id = unique(ingarch_result$result$id),
                                length = length$n/
                                  (as.numeric(unique(ingarch_result$result$frame))*as.numeric(unique(ingarch_result$result$history))))
```

```{r}
my_color_methods <- setNames(c("blue"),
                     c("ingarch"))

IngarchError_Sorted_split <- ingarch_model_error_split%>%group_by(group)%>%arrange(.,error)
IngarchQuantiles_split  <- quantile(IngarchError_Sorted_split $error,na.rm = T)

IngarchError_Sorted_split$index <- rep()

for(group_runvar in IngarchError_Sorted_split$group){
  IngarchError_Sorted_split$index[IngarchError_Sorted_split$group==group_runvar] <- seq(1:length(IngarchError_Sorted_split$index[IngarchError_Sorted_split$group==group_runvar]))
}


IngarchError_Sorted_split <- full_join(IngarchError_Sorted_split,TimeSeries_Length,bye ="id")

Quantiles_Index_split  <- data.frame(quant_ind=round(quantile(1:length(unique(IngarchError_Sorted_split$id)))))


Error_Sorted_split <- IngarchError_Sorted_split
Error_Sorted_split$group <- as.factor(Error_Sorted_split$group)

plot_quant_split <- ggplot(Error_Sorted_split ,aes(x=index,y=error,colour=model,size=length))+
  facet_wrap(vars(group),nrow=round(length(unique(IngarchError_Sorted_split$group))/2),scales = "free")+
  geom_point()+
  scale_y_continuous(limits=c(0,5))+
  geom_hline(yintercept=1,linewidth=2)+
# geom_point(data = CodaError_Sorted_split,aes(x=index,y=error,colour=model),size=3)+
  geom_vline(aes(xintercept=quant_ind),data=Quantiles_Index_split)+
  theme(text = element_text(size = text_size))+
  scale_colour_manual("Legend", values = c(my_color_methods),aesthetics = "colour")+
  ggtitle(paste("Error measures sorted",sep=" "),subtitle = paste("Window length:",frame,"History:",HistoryLength,"Main Cat.:",MainCat,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Quantile_Plot_Split",ids_save,"_histlgth",HistoryLength,"win_lgth",frame,"_maincat",MainCat,".png",sep="")),plot=plot_quant_split,height = 15,width = 20)
}
```



```{r}
my_color_methods <- setNames(c("blue"),
                     c("ingarch"))

IngarchError_Sorted <- ingarch_model_error %>% filter(model=="ingarch")%>%arrange(.,error)
IngarchQuantiles <- quantile(IngarchError_Sorted$error,na.rm = T)
IngarchError_Sorted$index <- seq(1:dim(IngarchError_Sorted)[1])
IngarchError_Sorted <- full_join(IngarchError_Sorted,TimeSeries_Length,bye ="id")

Quantiles_Index <- data.frame(quant_ind=findInterval(IngarchQuantiles,IngarchError_Sorted$error))

plot_quant <- ggplot(IngarchError_Sorted,aes(x=index,y=error,colour=model,size=length))+
  geom_point()+
  scale_y_continuous(limits=c(0,5))+
# geom_point(data = CodaError_Sorted,aes(x=index,y=error,colour=model,size=length))+
  geom_hline(yintercept=1,linewidth=2)+
  geom_vline(aes(xintercept=quant_ind),data=Quantiles_Index)+
  theme(text = element_text(size = text_size))+
  scale_colour_manual("Legend", values = c(my_color_methods),aesthetics = "colour")+
  ggtitle(paste("Error measures sorted",sep=" "),subtitle = paste("Window length:",frame, "History:",HistoryLength,"Main Cat.:",MainCat,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Quantile_Plot",ids_save,"_histlgth",HistoryLength,"win_lgth",frame,"_maincat",MainCat,".png",sep="")),plot=plot_quant,height = 15,width = 20)
}
```


```{r}
my_color <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))

coda_model_error_split$error[!is.finite(coda_model_error_split$error)] <- NA

mean_median_df <- data.frame(value = c(median(coda_model_error_split$error[coda_model_error_split$group=="1,2"],na.rm = T),
                                       median(coda_model_error_split$error[coda_model_error_split$group=="3,4"],na.rm = T),
                                       mean(coda_model_error_split$error[coda_model_error_split$group=="1,2"],na.rm = T),
                                        mean(coda_model_error_split$error[coda_model_error_split$group=="3,4"],na.rm = T)),
                             Lines = rep(c("median","mean"),each=2),
                             group = rep(c("1,2","3,4"),2))

phc <- ggplot(coda_model_error_split,aes(x=error,colour=group,fill=group))+
  geom_histogram(bins=100,position = "identity",alpha=0.3,linewidth=1)+
  scale_x_continuous(limits=c(0,8))+
  scale_y_continuous(limits=c(0,12))+
  geom_vline(xintercept = 1,linewidth=2)+
  geom_vline(aes(xintercept=value,colour=group,linetype=Lines),data = mean_median_df,linewidth=2)+
  scale_color_manual("Legend", values = c(my_color))+
  scale_fill_manual("Legend", values = c(my_color))+
  theme(text = element_text(size = text_size))+
  ggtitle(paste("Coda Error measures per group",sep=" "),subtitle = paste("Window length:",frame,"History:",HistoryLength,sep=" "))
phc

if(save_plots){
  ggsave(filename = here("Plots",paste("Coda_ErrorMeasure_PerGroup_Histogram",ids_save,"_histlgth",HistoryLength,"win_lgth",frame,".png",sep="")),plot=phc,height = 15,width = 20)
}
```



```{r}
my_color <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))

ingarch_model_error_split$error[!is.finite(ingarch_model_error_split$error)] <- NA

mean_median_df <- data.frame(value = c(median(ingarch_model_error_split$error[ingarch_model_error_split$group=="1,2"],na.rm = T),
                                       median(ingarch_model_error_split$error[ingarch_model_error_split$group=="3,4"],na.rm = T),
                                       mean(ingarch_model_error_split$error[ingarch_model_error_split$group=="1,2"],na.rm = T),
                                        mean(ingarch_model_error_split$error[ingarch_model_error_split$group=="3,4"],na.rm = T)),
                             Lines = rep(c("median","mean"),each=2),
                             group = rep(c("1,2","3,4"),2))


phi <- ggplot(ingarch_model_error_split,aes(x=error,colour=group,fill=group))+
  geom_histogram(bins=100,position = "identity",alpha=0.3)+
  scale_x_continuous(limits=c(0,8))+
  scale_y_continuous(limits=c(0,12))+
  geom_vline(xintercept = 1,linewidth=2)+
  geom_vline(aes(xintercept=value,colour=group,linetype=Lines),data = mean_median_df,linewidth=2)+
  scale_color_manual("Legend", values = c(my_color))+
  scale_fill_manual("Legend", values = c(my_color))+
  theme(text = element_text(size = text_size))+
  ggtitle(paste("Ingarch Error measures per group",sep=" "),subtitle = paste("Window length:",frame,"History:",HistoryLength,sep=" "))
phi
if(save_plots){
  ggsave(filename = here("Plots",paste("Ingarch_ErrorMeasure_PerGroup_Histogram",ids_save,"_histlgth",HistoryLength,"win_lgth",frame,".png",sep="")),plot=phi,height = 15,width = 20)
}
```


```{r}
my_color <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))

psc<-ggplot(coda_model_error_split,aes(x=id,y=error,col=group))+
  geom_point(size=3)+
  scale_y_continuous(limits=c(0,3))+
  theme(text = element_text(size = text_size))+
  scale_color_manual("Legend", values = c(my_color))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1))+
  ggtitle(paste("Coda Fridge error measures per group",sep=" "),subtitle = paste("Window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Coda_ErrorMeasure_PerGroup_PointPlot",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=psc,height = 15,width = 20)
}
```

```{r}
my_color <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))

psi<-ggplot(ingarch_model_error_split,aes(x=id,y=error,col=group))+
  geom_point(size=3)+
  scale_y_continuous(limits=c(0,3))+
  theme(text = element_text(size = text_size))+
  scale_color_manual("Legend", values = c(my_color))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1))+
  ggtitle(paste("Ingarch Error measures per group",sep=" "),subtitle = paste("Window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Ingarch_ErrorMeasure_PerGroup_PointPlot",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=psi,height = 15,width = 20)
}
```

Preparing Data for plotting

```{r}
FID <- 10

plot_data_coda<-coda_result$result%>%
  dplyr::filter(category %in% c(1,2,3,4), id==FID)%>%
  dplyr::select(!c(valuePredict_naive,predictionError_naive))

all_dates_and_categories<-plot_data_coda[,c("category","date")]

plot_data_ingarch <- ingarch_result$result %>% dplyr::filter(id==FID)
#plot_data_ingarch<-full_join(plot_data_ingarch,all_dates_and_categories)
plot_data_ingarch$model<-"ingarch"

plot_data <- bind_rows(plot_data_coda, plot_data_ingarch) %>% dplyr::select(!c(distribution, pivotGroup))

plot_data_zim <- zim_result$result %>% dplyr::filter(id==FID)





```

```{r eval=FALSE, include=FALSE}
FID = 6

ingarch1 <- Object.Load("F:/Uni/Masterarbeit/Simulation/Master-Thesis/Code/results/ingarch_result_ids_all__ext_FALSE_win_lgth05_pobs2_pmeansu1.RData")
ingarch2 <- Object.Load("F:/Uni/Masterarbeit/Simulation/Master-Thesis/Code/results/ingarch_result_ids_all__ext_TRUE_win_lgth05_pobs1_pmeansu1.RData")
frame <- 0.5

plot_data_ingarch_ext <- ingarch_ext$result %>% dplyr::filter(id==FID)
plot_data_ingarch_norm <- ingarch_norm$result %>% dplyr::filter(id==FID)

plot_data_ingarch_norm$model<-"NoExternal"
plot_data_ingarch_ext$model<-"External"

plot_data<-bind_rows(plot_data_ingarch_ext,plot_data_ingarch_norm)

```

```{r eval=FALSE, include=FALSE}

ingarch_ext_error <- Model.Error(ingarch_ext,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F)
ingarch_ext_error$model <- "External"
ingarch_norm_error <- Model.Error(ingarch_norm ,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = F)
ingarch_norm_error$model <- "NoExternal"
model_error <- rbind(ingarch_ext_error,ingarch_norm_error)



ingarch_ext_error_split <- Model.Error(ingarch_ext,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = T)
ingarch_ext_error_split$model <- "External"
ingarch_norm_error_split <- Model.Error(ingarch_norm,Fnct = "Mse") %>% Model.ErrorOverall(Fnct = "sum",SplitByGroup = T)
ingarch_norm_error_split$model <- "NoExternal"
model_error_split <- rbind(ingarch_ext_error_split,ingarch_norm_error_split)

                                             
```

```{r eval=FALSE, include=FALSE}
psa<-ggplot(model_error,aes(x=id,y=error,col=model))+
  geom_point(size=5)+
  scale_y_continuous(limits=c(0,3))+
  geom_hline(yintercept =1,linewidth=2)+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1,size=10))+
  ggtitle(paste("Error measures",sep=" "),subtitle = paste("Window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Ingarch_Both_ErrorMeasure_combined",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=psa,height = 15,width = 20)
}
```

```{r eval=FALSE, include=FALSE}
my_color_groups <- setNames(c("seagreen2", "blue4"),
                     c("1,2","3,4"))

my_color_methods <- setNames(c("red", "blue"),
                     c("External","NoExternal"))

ps<-ggplot(model_error_split,aes(x=id,y=error))+
  geom_point(size=7,shape=21,aes(colour=model,fill=group),stroke=4)+
  scale_y_continuous(limits=c(0,3))+
  geom_hline(yintercept =1,linewidth=2)+
  scale_fill_manual("Legend", values = c(my_color_groups),aesthetics = "fill")+
  scale_colour_manual("Legend", values = c(my_color_methods),aesthetics = "colour")+
  theme(text = element_text(size = text_size),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1,size=10))+
  ggtitle(paste("Error measures ",sep=" "),subtitle = paste("Window length:",frame,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("Ingarch_Both_ErrorMeasure_PointPlot",ids_save,"_ext","_",external,"win_lgth",frame,".png",sep="")),plot=ps,height = 15,width = 20)
}
```

Cumulated RMSEs 
```{r}
PlotErrorMeasure_Cum <- ErrorMeasure.Cumulated(plot_data,Fnct="Rmse")
PlotErrorMeasure_Cum$window <- factor(as.character(PlotErrorMeasure_Cum$window),levels=unique(PlotErrorMeasure_Cum$window))


p8 <- ggplot(PlotErrorMeasure_Cum, aes(y=errorMeasure,x=window,group=model,col=model))+
  facet_wrap(vars(category),nrow=length(unique(PlotErrorMeasure_Cum$category)),scales = "free")+
  geom_line()+
  geom_point(size=1.5)+
  theme(text = element_text(size = 30),axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1))+
    ggtitle(paste("Cumulated RMSE from right to left",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))

p8

if(save_plots){
ggsave(filename = here("Plots",paste("Ingarch_rmse_cum",FID,"win_lgth",frame,".png",sep="")),plot=p8,height = 15,width = 20)
  
}
```
Show whole timeseries
```{r}
data_raw <- weekly_category_data %>%
          filter(fridge_id == FID&
                   main_category_id %in% unique(ingarch_result$result$category)) %>%
          dplyr::select(week_date, main_category_id, sub_category_id, sold) %>%
          Data.Preparation(Category = unique(ingarch_result$result$category),TakeSubCategory = F) %>% 
          pivot_longer(cols=unique(ingarch_result$result$category),names_to="category",values_to="valueTrue")
names(data_raw)[1] <- c("date")
        
```


Ingarch Timeseries with prediction intervals

```{r}
p<-ggplot(plot_data_ingarch,aes(x=date,y=valuePredict),col="blue")+
  facet_wrap(vars(category),nrow=length(unique(plot_data_ingarch$category)),scales = "free")+
  geom_point(size=1)+
  geom_ribbon(aes(x=date,y=valuePredict,ymin=lowerBound,ymax=upperBound),
              data=plot_data_ingarch,inherit.aes = F,fill="grey90",linetype="dashed",col="blue")+
  geom_line(data=plot_data_ingarch,
            aes(x=date,y=valuePredict),col="blue")+
  geom_line(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  geom_point(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  theme(text = element_text(size = text_size))+
  ggtitle(paste("Ingarch Timeseries",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,",Main Cat.:",MainCat,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("ts_ing_id_",FID,"_win_lgth",frame,"_maincat",MainCat,".png",sep="")),plot=p,height = 15,width = 20)
}

```




Coda Timeseries with prediction intervals
```{r}
p0<-ggplot(plot_data_coda,aes(x=date,y=valuePredict),col="red")+
  facet_wrap(vars(category),nrow=length(unique(plot_data_coda$category)),scales = "free")+
  geom_point(size=1)+
  geom_ribbon(aes(x=date,y=valuePredict,ymin=lowerBound,ymax=upperBound),
              data=plot_data_coda,inherit.aes = F,fill="grey90",linetype="dashed",col="red")+
  geom_line(data=plot_data_coda,
            aes(x=date,y=valuePredict),col="red")+
  geom_line(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  geom_point(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  theme(text = element_text(size = text_size))+
  ggtitle(paste("Coda Timeseries",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))

if(save_plots){
 ggsave(filename = here("Plots",paste("ts_coda_id_",FID,"_pi","win_lgth",frame,".png",sep="")),plot=p0,height = 15,width = 20) 
}

```

Zim Model for Category 4
```{r}
p<-ggplot(plot_data_zim,aes(x=date,y=valuePredict),col="green")+
  facet_wrap(vars(category),ncol=length(1),scales = "free")+
  geom_point(size=1)+
  geom_line(data=plot_data_zim,
            aes(x=date,y=valuePredict),col="green")+
  geom_line(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  geom_point(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  theme(text = element_text(size = 50))+
  ggtitle(paste("Zim Timeseries",sep=" "),subtitle = paste("Fridge ID:",FID,sep=" "))

if(save_plots){
  ggsave(filename = here("Plots",paste("ts_ing_id_",FID,"_win_lgth",frame,"_maincat",MainCat,".png",sep="")),plot=p,height = 15,width = 20)
}

```


Comparing the timeseries with prediction intervals

```{r}
#my_color <- setNames(c("red", "blue"),
#                     c("coda","ingarch"))

p1<-ggplot(plot_data,aes(x=date,y=valuePredict,col=model))+
  facet_wrap(vars(category),nrow=length(unique(plot_data$category)),scales = "free")+
  geom_point(size=1)+
  geom_ribbon(aes(x=date,y=valuePredict,col=model,ymin=lowerBound,ymax=upperBound,fill=model),
              data=plot_data,alpha=0.15,inherit.aes = F,linetype="dashed")+
  geom_line(data=plot_data,
            aes(x=date,y=valuePredict,col=model))+
  geom_line(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  geom_point(data=data_raw,aes(x=date,y=valueTrue),col="black",inherit.aes = F)+
  #scale_color_manual("Legend", values = c(my_color))+
  ggtitle(paste("Actual Timeseries vs. predicted ",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))+
  theme(text = element_text(size = text_size))  

if(save_plots){
ggsave(filename = here("Plots",paste("Ingarch_ts_both_id_",FID,"_pi","ing_ext",external,"win_lgth",frame,".png",sep="")),plot=p1,height = 15,width = 20)
  
}
```



Comparing the prediction errors of the models

```{r}
p2<-ggplot(plot_data,aes(x=model,y=predictionError))+
  facet_wrap(vars(category),ncol=length(unique(plot_data$category)),scales = "fixed")+
  geom_boxplot()+
  ggtitle("Prediction error",subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))+
  theme(text = element_text(size = text_size))+
  geom_hline(yintercept = 0,col="blue4")

if(save_plots){
 ggsave(filename = here("Plots",paste("box_pred_err_id",FID,"win_lgth",frame,".png",sep="")),plot=p2,height = 15,width = 20)
 
}
```




Normed Prediction errors 
```{r}
p3 <- ggplot(plot_data,aes(x=date,y=predictionError_normed,col=model))+
  facet_wrap(vars(category),nrow=length(unique(plot_data$category)),scales = "free")+
  geom_point(size=1.5,aes(shape=model))+
  geom_line()+
  theme(text = element_text(size = text_size))+
  geom_line(aes(y=0),col="black")+
  ggtitle(paste("Normed prediction error over time ",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))#+
 # scale_color_manual("Legend", values = c(my_color))

if(save_plots){
 ggsave(filename = here("Plots",paste("Ingarch_pred_err_norm_id",FID,"win_lgth",frame,".png",sep="")),plot=p3,height = 15,width = 20)
 
}
```



```{r}
p4<-ggplot(plot_data,aes(x=model,y=predictionError_normed))+
  facet_wrap(vars(category),ncol=length(unique(plot_data$category)),scales = "fixed")+
  geom_boxplot()+
  ggtitle("Normed prediction error per method and category",subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))+
  theme(text = element_text(size = text_size))+
  geom_hline(yintercept = 0,col="blue4")

if(save_plots){
 ggsave(filename = here("Plots",paste("Ingarch_box_pred_err_norm_id",FID,"win_lgth",frame,".png",sep="")),plot=p4,height = 15,width = 20)
 
}
```

Prediction error over time
```{r}
p6 <- ggplot(plot_data,aes(x=date,y=predictionError,col=model))+
  facet_wrap(vars(category),nrow=length(unique(plot_data$category)),scales = "free")+
  geom_point(size=1.5,aes(shape=model))+
  geom_line()+
  theme(text = element_text(size = text_size))+
  geom_line(aes(y=0),col="black")+
  ggtitle(paste("Prediction error over time ",sep=" "),subtitle = paste("Fridge ID:",FID,",base window length:",frame,sep=" "))+
  scale_color_manual("Legend", values = c(my_color))

if(save_plots){
ggsave(filename = here("Plots",paste("pred_err_id",FID,"win_lgth",frame,".png",sep="")),plot=p6,height = 15,width = 20)
  
}
```


