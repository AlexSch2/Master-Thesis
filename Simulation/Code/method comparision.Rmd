---
title: "Method comparision"
author: "Alexander Schwaiger"
date: "2023-01-20"
output: pdf_document
---
```{r eval=FALSE, message=FALSE, warning=FALSE}
source("General_Dependency.R")
source("Coda_Function.R") 
source("Ingarch_Function.R")
source("ZIM_Function.R")
source("General_Function.R")
source("General_PlotFunctions.R")
```

Preparation
```{r eval = FALSE}

#Choosing only fridges with all 4 categories
help1 <- weekly_category_data%>%
  group_by(fridge_id)%>%
  dplyr::select(main_category_id)%>%
  unique()%>%
  count(fridge_id)
  
ids_all <- help1$fridge_id[help1$n ==4]

ids <- ids_all

if(all(ids == ids_all)){
  ids_save <- "_all_"
}else {
  ids_save <- paste(ids,collapse = "-")
}

frame <- 0.5
window_method <- "extending"
save_results <- F
HistoryLength <- 1

#Ingarch specifications
MainCat <- 2

#Coda specifications

```


Performing the Analysis
```{r eval=FALSE, include=FALSE}
coda_result <-
  Coda.Analysis(
    Data_Raw  = weekly_category_data,
    Id = ids_all,
    Frame = frame,
    OneVsAll = F,
    PivotGroup =  c("1", "2"),
    TSpace = T,
    Log = T,
    ZeroHandling = "all",
    WindowMethod = window_method,
    HistoryLength = HistoryLength
  )

if(save_results){
  save(coda_result,file=here("Code/results",paste("coda_result_ids",paste(ids_save,collapse="-"),"no_ova",".RData",sep="")))
}


ingarch_result <-
  Ingarch.Analysis(
    Data_Raw= weekly_category_data,
    Id = ids_all,
    Frame = frame,
    Distribution = "poisson",
    Category_Main = c("3", "4"),
    WindowMethod = window_method,
    ZeroHandling = "none",
    External = F,
    Multicore = T,
    NCores = 10,
    PastOb = 1,
    PastMean = 1,
    HistoryLength = HistoryLength,
    TakeSubCategory = F
  )
  
  if(T){
  save(ingarch_result,file=here("Code/results",paste("ingarch_result_ids",paste(ids_save,collapse="-"),".RData",sep="")))

  }

zim_result <- Zim.Analysis(
    Data_Raw = weekly_category_data,
    Id = ids_all,
    Frame = frame,
    Distribution = "poisson",
    Category_Main = c("1","2", "3","4"),
    Category_Calculated = c("3","4"),
    WindowMethod = window_method,
    Multicore = F,
    HistoryLength = 1,
    TakeSubCategory = F
  )

  if(save_results){
  save(zim_result,file=here("Code/results",paste("zim_result_ids",paste(ids_save,collapse="-"),"cat34",".RData",sep="")))

  }
```

Loading previous result
```{r}
ids <- unique(coda_result$result$id)
PredictionStep <- 1
frame <- unique(coda_result$result$frame)
window_method <- unique(coda_result$result$windowMethod)
save_results <- F
HistoryLength <- unique(coda_result$result$history)

#Ingarch specifications
distr<-unique(ingarch_result$result$distribution)
zero_handling_ingarch <- unique(ingarch_result$result$zeroHandling)
external <- unique(ingarch_result$result$external)
if(external){
  external_plot <-"with external factors"
}else external_plot <- ""
past_means <- unique(ingarch_result$result$pastMean)
past_obs <- unique(ingarch_result$result$pastOb)
ingarch_settings <- expand_grid(past_means,past_obs)
MainCat <- unique(ingarch_result$result$main_category)


#Coda specifications
#zero_handling_coda<-unique(coda_result$result$zero_handling)
tspace<-T
take_log<-T
one_vs_all<-T

if(!identical(ids,unique(ingarch_result$result$id)) || 
   frame != unique(ingarch_result$result$frame) ||
   window_method != unique(ingarch_result$result$windowMethod) ||
   HistoryLength != unique(ingarch_result$result$history)) {
  stop("Ingarch and Coda base specifications differ")
}
```


```{r}
Coda1 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/coda_result_ids_all_.RData")
Coda2 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/coda_result_ids_all_no_ova.RData")
#Coda3 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/coda_result_ids_all_frame07.RData")

Ingarch1 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/ingarch_result_ids_all_.RData")
Ingarch2 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/ingarch_result_ids_all__nbinom.RData")
#Ingarch3 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/ingarch_result_ids_all_frame07.RData")

Coda_Combined <- rbind(Coda1$result,
                       Coda2$result
#                       ,Coda3$result
                       )
Ingarch_Combined <- rbind(Ingarch1$result,
                          Ingarch2$result
#                          ,Ingarch3$result
                          )

######CODA; INGARCH ; ZIM ######

Plot.MethodComparision(IngarchResult = ingarch_result,CodaResult = coda_result,ZimResult = zim_result)
zim_zeros <- zim_result$result%>% group_by(category,id) %>% summarise(n=sum(valuePredict==0))
ingarch_zeros <- ingarch_result$result %>% filter(category%in% c(3,4))%>% group_by(category,id) %>% summarise(n=sum(valuePredict==0))
zim_zeros$model <- "zim"
ingarch_zeros$model <- "ingarch"
plot.data <- rbind(zim_zeros,ingarch_zeros)
p <- ggplot(plot.data,aes(x=id,y=n,col=model))+
  facet_wrap(vars(category),nrow=2,scales="free")+
  geom_point(size=5)+
  theme(text = element_text(size = 30,angle = 45, vjust = 0.5, hjust=1))+
  scale_colour_manual("Legend", values = setNames(c("green","blue"),c("zim","ingarch")),aesthetics = "colour")+
  ylab("Amount of zeros")


#########BOTH METHODS############
#History
Plot.ErrorMeasureCombined(CodaCombined = Coda_Combined,IngarchCombined = Ingarch_Combined,Values=c("0.5","1"),Split=F,Variation = "history",LabelNames = c("0.5"="h=0.5","1"="h=1")

#Frames
Plot.ErrorMeasureCombined(CodaCombined = Coda_Combined,IngarchCombined = Ingarch_Combined,Values=c("0.3","0.5","0.7"),Split=F,Variation = "frame",LabelNames = c("0.3"="w=0.3","0.5"="w=0.5","0.7"="w=0.7"))

#Window Method
Plot.ErrorMeasureCombined(CodaCombined = Coda_Combined,IngarchCombined = Ingarch_Combined,Values=c("fixed","extending"),Split=F,Variation = "windowMethod",LabelNames = c("fixed"="Fixed","extending"="Extending"))


########ONE METHOD##############
#####INGARCH######
#Distribution
Ingarch2 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/ingarch_result_ids_all__nbinom.RData")
Result_Combined <- rbind(Ingarch1$result,Ingarch2$result)
Plot.ErrorMeasureSingle(ResultCombined=Result_Combined,Variation=c("Distribution"="distribution"),LabelNames=c("Poisson","Negativ Binomial"),Split=F,Category = c(1,2,3,4),Values = c("poisson","nbinom"))

#Past Mean
Ingarch2 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/ingarch_result_ids_all_pm2.RData")
Result_Combined <- rbind(Ingarch1$result,Ingarch2$result)
Plot.ErrorMeasureSingle(ResultCombined=Result_Combined,Variation=c("Past Means"="pastMean"),LabelNames=c("1","2"),Split=F,Category = c(1,2,3,4),Values = c("1","2"))

#Past Observations
Ingarch2 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/ingarch_result_ids_all_po2.RData")
Result_Combined <- rbind(Ingarch1$result,Ingarch2$result)
Plot.ErrorMeasureSingle(ResultCombined=Result_Combined,Variation=c("Past Observations"="pastOb"),LabelNames=c("1","2"),Split=F,Category = c(1,2,3,4),Values = c("1","2"))
#####CODA#####
#Zero Handling
Coda2 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/coda_result_ids_all_zeros_only.RData")
Result_Combined <- rbind(Coda1$result,Coda2$result)
Plot.ErrorMeasureSingle(ResultCombined=Result_Combined,Variation=c("Zero handling"="zeroHandling"),LabelNames=c("All","Zeros Only"),Split=F,Category = c(1,2,3,4),Values = c("all","zeros_only"))

#TSpaces
Coda2 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/coda_result_ids_all_no_Tspace.RData")
Result_Combined <- rbind(Coda1$result,Coda2$result)
Plot.ErrorMeasureSingle(ResultCombined=Result_Combined,Variation=c("T-Space"="tSpace"),LabelNames=c("T-Space","No T-Space"),Split=F,Category = c(1,2,3,4),Values = c(TRUE,FALSE))

#OneVsAll
Coda2 <- Object.Load("F:/Uni/Masterarbeit/Master-Thesis_git/Simulation/Code/results/coda_result_ids_all_no_ova.RData")
Result_Combined <- rbind(select(Coda1$result,-pivotGroup),Coda2$result)
Plot.ErrorMeasureSingle(ResultCombined=Result_Combined,Variation=c("One-vs-All"="oneVsAll"),LabelNames=c("Used","Not Used"),Split=F,Category = c(1,2),Values = c(TRUE,FALSE))
```
